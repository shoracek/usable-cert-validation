<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Let's make the validation of TLS certificates usable.">
<meta name="author" content="Centre for Research on Cryptography and Security, Masaryk University, Czechia">

<title>Developer guide: OpenSSL</title>

<!-- Matomo Tag Manager -->
<script type="text/javascript">
  var _mtm = window._mtm = window._mtm || [];
  _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
  g.type='text/javascript'; g.async=true; g.src='https://fadmin.fi.muni.cz/piwik/js/container_PX176f6U.js'; s.parentNode.insertBefore(g,s);
  </script>
<!-- End Matomo Tag Manager -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link href="/assets/css/main.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/036c3720fc.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700&display=swap&subset=latin-ext" rel="stylesheet">
<link rel="icon" type="image/png" href="/assets/img/favicon.png">

</head>
<body data-spy="scroll" data-target="#navbar" data-offset="100">
  <nav class="navbar navbar-expand-md navbar-light fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/">
            <span class="fa-stack">
                <span class="fas fa-fw fa-lg fa-certificate fa-stack-1x color-verydarkgrey"></span>
                <span class="fas fa-fw fa-xs fa-check fa-stack-1x color-white"></span>
            </span>
            Developer guide: OpenSSL
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Show/hide navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbar">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item" data-toggle="collapse" data-target=".navbar-collapse.show">
                    <a class="nav-link" href="/#home">Intro</a>
                </li>
                <li class="nav-item dropdown" data-toggle="collapse" data-target=".navbar-collapse.show">
                    <a class="nav-link dropdown-toggle" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Libraries</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown01">
                        
                          <a class="dropdown-item" href="/#openssl">
                          OpenSSL</a>
                        
                          <a class="dropdown-item" href="/gnutls#gnutls">
                          GnuTLS</a>
                        
                          <a class="dropdown-item" href="/botan#botan">
                          Botan</a>
                        
                          <a class="dropdown-item" href="/mbedtls#mbedtls">
                          Mbed TLS</a>
                        
                          <a class="dropdown-item" href="/openjdk#openjdk">
                          OpenJDK</a>
                        
                    </div>
                </li>
                <li class="nav-item dropdown" data-toggle="collapse" data-target=".navbar-collapse.show">
                    <a class="nav-link dropdown-toggle" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Guides</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown01">
                        
                            
                            
                                <a class="dropdown-item" href="#openssl">
                                OpenSSL</a>
                            
                        
                            
                            
                                <a class="dropdown-item" href="/guides/gnutls">
                                GnuTLS</a>
                            
                        
                            
                            
                        
                            
                            
                                <a class="dropdown-item" href="/guides/mbedtls">
                                Mbed TLS</a>
                            
                        
                            
                            
                        
                    </div>
                </li>
                <li class="nav-item" data-toggle="collapse" data-target=".navbar-collapse.show">
                    <a class="nav-link" href="/faq">FAQ</a>
                </li>
                <li class="nav-item" data-toggle="collapse" data-target=".navbar-collapse.show">
                    <a class="nav-link" href="#about">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

  <main role="main">
    <div class="section"><div class="container">

    <h1 id="openssl">Developer guide: OpenSSL</h1>

    <p class="lead">This guide describes the implementation of a TLS client in <a href="https://www.openssl.org/" target="_blank" rel="noopener noreferrer" class="ext-link">OpenSSL</a>.</p>

    <p class="lead">The guide covers basic aspects of initiating a secure TLS connection, including certificate validation and hostname verification. When various alternative approaches are possible, the guide presents each of them and specifies their use cases to help you choose which approach suits your needs best.</p>

    <ul>
      <li>We work with the API in C of OpenSSL, version 1.1.1.</li>
      <li>We assume the server to communicate with is at <code class="language-plaintext highlighter-rouge">x509errors.org</code> and accepts TLS connections on a standard port <code class="language-plaintext highlighter-rouge">443</code>.</li>
    </ul>

    <div class="alert alert-warning" role="alert">
      <p>Note: For now, the guide <em>does not</em> cover revocation checking and advanced techniques that may follow after the connection is already established, e.g. session resumption.</p>
    </div>

  </div></div>
<div class="section"><div class="container">

    <h2 id="establishing-an-underlying-tcpip-connection">Establishing an underlying TCP/IP connection</h2>

    <p>First, we need to establish an <em>insecure</em> TCP/IP connection with the server. For the most simple connection, a standard set of <em>POSIX</em> functions will suffice.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cm">/* TCP/IP socket descriptor. */</span>
<span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* We will send the server our connection preferences in the form of hints. */</span>
<span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="cm">/* We allow both IPv4 and IPv6. */</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
<span class="cm">/* We want a stream socket, not a datagram one. */</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
<span class="cm">/* We know the numeric port number beforehand. */</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_ADDRCONFIG</span> <span class="o">|</span> <span class="n">AI_NUMERICSERV</span><span class="p">;</span>
<span class="cm">/* We want to use TCP. */</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* We query a list of addresses for the given hostname. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">"x509errors.org"</span><span class="p">,</span> <span class="s">"443"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Try to connect to each address from the server list until successful. */</span>
<span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">rr</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">rr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">rr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We don't need the server info anymore. */</span>
<span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="cm">/* We must fail if we didn't manage to connect to any server address. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>If everything went well, <code class="language-plaintext highlighter-rouge">sockfd</code> is now a descriptor of a valid, connected socket. We can proceed to establishing the TLS connection on top of the TCP/IP connection.</p>

    <h3 id="relevant-links">Relevant links</h3>

    <ul>
      <li>
<a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">getaddrinfo</code></a> (linux manpages)</li>
      <li>
<a href="https://tools.ietf.org/html/rfc791" target="_blank" rel="noopener noreferrer" class="ext-link">Internet Protocol</a> (RFC 791)</li>
      <li>
<a href="https://tools.ietf.org/html/rfc793" target="_blank" rel="noopener noreferrer" class="ext-link">Transmission Control Protocol</a> (RFC 793)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 id="creating-a-tls-context">Creating a TLS context</h2>

    <p>Before we connect, a TLS context structure has to be created. It will store all the necessary configuration and settings needed for our session.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;openssl/ssl.h&gt;
</span>
<span class="cm">/* Create the context. We will use the version-flexible TLS method to negotiate.
** This means that we prefer the highest supported version, but agree with downgrading. */</span>
<span class="n">SSL_CTX</span> <span class="k">const</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">SSL_CTX_new</span><span class="p">(</span><span class="n">TLS_client_method</span><span class="p">());</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* However, we won't let the server downgrade to less than TLS v1.2, since older TLS versions are deprecated. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_CTX_set_min_proto_version</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">TLS1_2_VERSION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We need to set the option to validate the peer certificate chain.
** If we skipped this step, an active attacker could impersonate the server. */</span>
<span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SSL_VERIFY_PEER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* In certificate validation, we usually want to trust the system default certificate authorities. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_CTX_set_default_verify_paths</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-1">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_new.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_new</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_set_min_proto_version.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_set_min_proto_version</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_set_verify.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_set_verify</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_set_default_verify_paths.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_set_default_verify_paths</code></a> (OpenSSL docs)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 class="text-danger" id="alternative-setting-an-arbitrary-trust-anchor">Alternative: Setting an arbitrary trust anchor</h2>

    <p>In some cases, it might be useful to trust an arbitrary certificate authority. This could be the case during testing, or within company intranets. If we trust a CA located in <code class="language-plaintext highlighter-rouge">trusted_ca.pem</code> and other authorities located in <code class="language-plaintext highlighter-rouge">trusted_dir</code>, we can easily change the trust setting as follows:</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cm">/* Both the file path and the directory path can be set to NULL if they are not used */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_CTX_load_verify_locations</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"trusted_ca.pem"</span><span class="p">,</span> <span class="s">"trusted_dir"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-2">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_load_verify_locations.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_load_verify_locations</code></a> (OpenSSL docs)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 class="text-success" id="optional-custom-certificate-validation-settings">Optional: Custom certificate validation settings</h2>

    <p>Optionally, you may want to put additional constraints on certificate validation. OpenSSL allows for this by modifying the <code class="language-plaintext highlighter-rouge">verify params</code> structure. In this example, we enforce strict certificate validation and put requirements on the IP address contained in the <em>Subject Alternative Name</em> extension of the server certificate. All possible settings and flags can be found in the original <a href="https://www.openssl.org/docs/man1.1.0/man3/X509_VERIFY_PARAM_set_flags.html" target="_blank" rel="noopener noreferrer" class="ext-link">documentation</a></p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;openssl/x509.h&gt;
#include &lt;openssl/x509_vfy.h&gt;
</span>
<span class="cm">/* Retrieve the verification parameters for modification. */</span>
<span class="n">X509_VERIFY_PARAM</span> <span class="o">*</span><span class="n">vpm</span> <span class="o">=</span> <span class="n">SSL_CTX_get0_param</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">vpm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Retrieve certificate validation flags. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">X509_VERIFY_PARAM_get_flags</span><span class="p">(</span><span class="n">vpm</span><span class="p">);</span>

<span class="cm">/* Enable the strict certificate validation flag.
** Certificates with e.g. duplicate extensions, will now be rejected. */</span>
<span class="n">flags</span> <span class="o">|=</span> <span class="n">X509_V_FLAG_X509_STRICT</span><span class="p">;</span>

<span class="cm">/* Put the modified validation flags back into the params structure. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">X509_VERIFY_PARAM_set_flags</span><span class="p">(</span><span class="n">vpm</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Server certificate will have to contain IP 192.168.2.1 in its Subject Alternative Name. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">X509_VERIFY_PARAM_set1_ip_asc</span><span class="p">(</span><span class="n">vpm</span><span class="p">,</span> <span class="s">"192.168.2.1"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-3">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_get0_param.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_get0_param</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/X509_VERIFY_PARAM_set_flags.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">X509_VERIFY_PARAM_set_flags</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.6" target="_blank" rel="noopener noreferrer" class="ext-link">Subject Alternative Name Extension</a> (RFC 5280)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 id="initializing-a-tls-connection">Initializing a TLS connection</h2>

    <p>At this point, we can initialize a connection structure and link it with the open socket descriptor. After that, we only need to specify a couple of settings and we can connect to the server.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cm">/* Initialize a TLS connection structure. */</span>
<span class="n">ssl</span> <span class="o">=</span> <span class="n">SSL_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ssl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Bind the socket descriptor to the connection structure. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_set_fd</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the Server Name Indication TLS extension to specify the name of the server. */</span>
<span class="cm">/* This is required when multiple servers are running at the same IP address (virtual hosting). */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_set_tlsext_host_name</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">"x509errors.org"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set hostname for verification. */</span>
<span class="cm">/* Not setting the hostname would mean that we would accept a certificate of any trusted server. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_set1_host</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">"x509errors.org"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Connect to the server, this performs the TLS handshake. */</span>
<span class="cm">/* During this procedure, the peer certificate is validated. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_connect</span><span class="p">(</span><span class="n">ssl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-4">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_new.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_new</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_set_fd.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_set_fd</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_set_tlsext_host_name.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_set_tlsext_host_name</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_set1_host.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_set1_host</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_connect.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_connect</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://datatracker.ietf.org/doc/html/rfc6066#section-3" target="_blank" rel="noopener noreferrer" class="ext-link">Server Name Indication</a> (RFC 6066)</li>
      <li>
<a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4" target="_blank" rel="noopener noreferrer" class="ext-link">TLS handshake</a> (RFC 5246)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 class="text-success" id="optional-checking-the-result-of-peer-certificate-validation">Optional: Checking the result of peer certificate validation</h2>

    <p>If certificate validation fails, <code class="language-plaintext highlighter-rouge">SSL_connect()</code> will always fail with the same error message. In that case, it is often useful to examine the specific certificate validation error as follows. You can find explanations of certificate validation messages in the official <a href="https://www.openssl.org/docs/manmaster/man3/X509_STORE_CTX_get_error.html" target="_blank" rel="noopener noreferrer" class="ext-link">documentation</a> or on our <a href="https://x509errors.org/#openssl" target="_blank" rel="noopener noreferrer" class="ext-link">page</a>.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cm">/* Retrieve the error code of the error that occured during certificate validation. */</span>
<span class="kt">int</span> <span class="n">verifyResult</span> <span class="o">=</span> <span class="n">SSL_get_verify_result</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>

<span class="cm">/* Convert the error code to a human-readable string. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="n">X509_verify_cert_error_string</span><span class="p">(</span><span class="n">verifyResult</span><span class="p">);</span>

<span class="cm">/* Print the string to the standard error output. */</span>
<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-5">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_get_verify_result.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_get_verify_result</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/X509_verify_cert_error_string.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">X509_verify_cert_error_string</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/X509_STORE_CTX_get_error.html" target="_blank" rel="noopener noreferrer" class="ext-link">Certificate validation errors</a> (OpenSSL docs)</li>
      <li>
<a href="https://x509errors.org/#openssl" target="_blank" rel="noopener noreferrer" class="ext-link">Certificate validation errors</a> (x509errors.org)</li>
      <li>
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-6" target="_blank" rel="noopener noreferrer" class="ext-link">Certificate path validation</a> (RFC 5280)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 id="sending-and-receiving-data-using-the-tls-connection">Sending and receiving data using the TLS connection</h2>

    <p>When the connection is successfully established, we can share application data with the server. These two functions provide the basic interface.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cm">/* Prepare a message and send it to the server. */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">"Hello server"</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_write</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Prepare a static buffer for the response and read the response into that buffer. */</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SSL_read</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-6">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_write.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_write</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_read.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_read</code></a> (OpenSSL docs)</li>
    </ul>

  </div></div>
<div class="section"><div class="container">

    <h2 id="closing-the-tls-connection">Closing the TLS connection</h2>

    <p>The client is usually the one to indicate that the connection is finished. When we want the connection closed, the following steps are performed.</p>

    <div class="language-c highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="cm">/* To finish the connection properly, we send a "close notify" alert to the server. */</span>
<span class="cm">/* In most cases, we have to wait for the same message from the server, and perform the call again. */</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SSL_shutdown</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SSL_shutdown</span><span class="p">(</span><span class="n">ssl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Free the TLS connection structure. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ssl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SSL_free</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Free the TLS context structure. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SSL_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Close the underlying TCP socket. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <h3 id="relevant-links-7">Relevant links</h3>

    <ul>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_shutdown.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_shutdown</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_free.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_free</code></a> (OpenSSL docs)</li>
      <li>
<a href="https://www.openssl.org/docs/manmaster/man3/SSL_CTX_free.html" target="_blank" rel="noopener noreferrer" class="ext-link"><code class="language-plaintext highlighter-rouge">SSL_CTX_free</code></a> (OpenSSL docs)</li>
    </ul>

  </div></div>

  </main>
  <div id="feedback">
    <div class="card card-body collapsed">
        <h4>Feedback</h4>
        <p>Something is not working? File a bug report to our repository, please.</p>
        <a class="ext-link btn btn-primary d-block mb-3" href="https://github.com/crocs-muni/usable-cert-validation/issues/new?labels=bug&amp;title=Bug+report&amp;body=Please+describe+what+does+not+work..." target="_blank" rel="noopener noreferrer">
    <span class="fas fa-fw fa-bug color-white"></span>
  
 Bug report</a>
        <p>Other comments or ideas?</p>
        <a class="btn btn-primary d-block" target="_blank" href="mailto:webmaster@x509errors.org?subject=Site+feedback">
    <span class="fas fa-fw fa-envelope color-white"></span>
  
 Email us!</a>
    </div>
    <div class="btn btn-secondary">
<span class="fas fa-fw fa-question-circle"></span> Feedback</div>
</div>

  <footer>
    <div class="container clearfix">
        <span class="footer-left">
            <a class="no-ext-link-icon" href="mailto:webmaster@x509errors.org" title="Contact email">
            <span class="fas fa-fw fa-envelope"></span> webmaster@x509errors.org</a><br>
            <a class="ext-link no-ext-link-icon" href="https://github.com/crocs-muni/usable-cert-validation" title="GitHub repository" target="_blank" rel="noopener noreferrer">
            <span class="fab fa-fw fa-github"></span> usable-cert-validation</a><br>
            <a class="ext-link no-ext-link-icon" href="https://github.com/crocs-muni/usable-cert-validation/commit/4b27299ce269931a06d3fe8d0a9753cd502e537d" title="Last modification" target="_blank" rel="noopener noreferrer">
            <span class="fas fa-fw fa-clock"></span> 2021-10-03</a>
        </span>
        <span class="footer-right">
            Â© 2020 <a class="ext-link no-ext-link-icon" href="https://muni.cz/" target="_blank" rel="noopener noreferrer">Masaryk University</a><br>
            <a class="ext-link no-ext-link-icon" href="https://crocs.fi.muni.cz/" target="_blank" rel="noopener noreferrer">Centre for Research on Cryptography and Security</a>
        </span>
    </div>
</footer>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="/assets/js/main.js"></script>
</body>
</html>
